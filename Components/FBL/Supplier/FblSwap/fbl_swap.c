/***********************************************************************************************************************
 *  FILE DESCRIPTION
 *  ------------------------------------------------------------------------------------------------------------------*/
/** \file
 *  \brief         Ease access of HW specific swap functionalities - Tricore
 *
 *  --------------------------------------------------------------------------------------------------------------------
 *  COPYRIGHT
 *  --------------------------------------------------------------------------------------------------------------------
 *  \par Copyright
 *  \verbatim
 *  Copyright (c) 2022 by Vector Informatik GmbH.                                                  All rights reserved.
 *
 *                This software is copyright protected and proprietary to Vector Informatik GmbH.
 *                Vector Informatik GmbH grants to you only those rights as set out in the license conditions.
 *                All other rights remain with Vector Informatik GmbH.
 *  \endverbatim
 */
/**********************************************************************************************************************/

/***********************************************************************************************************************
 *  REVISION HISTORY
 *  --------------------------------------------------------------------------------------------------------------------
 *  Version    Date        Author  Change Id        Description
 *  ------------------------------------------------------------------------------------------------------------------
 *  01.00.00   2020-07-29  vistmo  FBL-1489         Initial version
 *  01.01.00   2022-03-31  vishor  FBL-4808         Add GetSwapState API
 **********************************************************************************************************************/

#define FBL_SWAP_SOURCE

/***********************************************************************************************************************
 *  INCLUDES
 **********************************************************************************************************************/

/* Common Bootloader includes */
#include "fbl_inc.h"
#include "fbl_swap.h"
#include "flash_sfr.h"

/***********************************************************************************************************************
 *  VERSION
 **********************************************************************************************************************/

#if ((FBLDRVSWAP_TRICORE_VERSION != 0x0101u) || \
     (FBLDRVSWAP_TRICORE_RELEASE_VERSION != 0x00u))
# error "Error in fbl_swap.c: Source and header file are inconsistent!"
#endif

/***********************************************************************************************************************
 *  CONFIGURATION CHECKS
 **********************************************************************************************************************/

#if !defined ( FLASH_ENABLE_TRICORE_SWAP ) || \
    !defined ( FLASH_ENABLE_TRICORE_SWAP_ROUTINE )
# error "This module cannot be used in the current configuration (SWAP DISABLED)"
#endif

/***********************************************************************************************************************
 *  DEFINES
 **********************************************************************************************************************/

/***********************************************************************************************************************
 *  GLOBAL DATA
 **********************************************************************************************************************/

/***********************************************************************************************************************
 *  LOCAL DATA
 **********************************************************************************************************************/

/***********************************************************************************************************************
 *  GLOBAL FUNCTIONS
 **********************************************************************************************************************/

#define FBLDRVSWAP_START_SEC_CODE
#include "MemMap.h" /* PRQA S 5087 */ /* MD_MSR_MemMap */

/***********************************************************************************************************************
 *  FblSwapPrepare
 **********************************************************************************************************************/
/*! \brief       Prepares the HW swap
 *  \details     Switches in NV memory the swap state
 *  \return      kFblOk if swap preparation was successful, otherwise kFblFailed
 **********************************************************************************************************************/
tFblResult FblSwapPrepare( void )
{
   tFblResult result = kFblOk;

   if (FlashDriver_SwapPartitions() != kFblOk)
   {
      result = kFblFailed;
   }

   return result;
}

/***********************************************************************************************************************
 *  FblSwapActivate
 **********************************************************************************************************************/
/*! \brief       Activates the HW swap
 *  \return      kFblOk
 **********************************************************************************************************************/
tFblResult FblSwapActivate( void )
{
   /* The activation is not relevant for the Tricore architecture
    * because the swap configuration is permanent (reset-persistent).
    */
   return kFblOk;
}

/***********************************************************************************************************************
 *  FblSwapInitPowerOn
 **********************************************************************************************************************/
/*! \brief       Initializes swap module
 **********************************************************************************************************************/
void FblSwapInitPowerOn(void)
{
   /* Do nothing, only present for compatibility */
}

/***********************************************************************************************************************
 *  FblSwapGetSwapState
 **********************************************************************************************************************/
/*! \brief       Provides current active swap state
 *  \return      Always kFblOk
 **********************************************************************************************************************/
tFblResult FblSwapGetSwapState( V_MEMRAM1 vuint8 V_MEMRAM2 V_MEMRAM3 *swapState )
{
   switch (FLASH_SCU_SWAPCTRL & 0x03uL)   /* PRQA S 0303 */ /* MD_FblDrvSwap_0303 */
   {
      case 1u:
      {
         *swapState = FBL_SWAP_STATE_INITIAL;
         break;
      }
      case 2u:
      {
         *swapState = FBL_SWAP_STATE_ALTERNATIVE;
         break;
      }
      default:
      {
         *swapState = FBL_SWAP_STATE_INVALID;
         break;
      }
   }

   return kFblOk;
}

#define FBLDRVSWAP_STOP_SEC_CODE
#include "MemMap.h" /* PRQA S 5087 */ /* MD_MSR_MemMap */

/***********************************************************************************************************************
 *  MISRA DEVIATIONS
 **********************************************************************************************************************/

/* Module specific MISRA deviations:

   MD_FblDrvSwap_0303:
      Reason:     Casts are used for SFR access.
      Risk:       No identifiable risk.
      Prevention: No prevention necessary.

*/

/***********************************************************************************************************************
 *  END OF FILE: FBL_SWAP.C
 **********************************************************************************************************************/
